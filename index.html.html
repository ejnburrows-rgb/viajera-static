<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viajera Digital - El Guajiro de Hialeah | v3.3 STABLE</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Lora:wght@400;500;600&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cuban-gold: #D4A855;
            --cuban-brown: #8B4513;
            --cuban-cream: #F5E6D3;
            --cuban-dark: #2C1810;
            --success: #22C55E;
            --error: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
        }

        /* Improved Scrollbar for Cross-Browser Support */
        * {
            scrollbar-width: thin;
            scrollbar-color: #D4A855 #2C1810;
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: rgba(26, 15, 10, 0.5);
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(212, 168, 85, 0.5);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 168, 85, 0.7);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Lora', serif;
            background: linear-gradient(135deg, #1a0f0a 0%, #2C1810 50%, #1a0f0a 100%);
            min-height: 100vh;
        }

        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .gold-gradient {
            background: linear-gradient(135deg, #D4A855 0%, #F0D78C 50%, #D4A855 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .cuban-card {
            background: linear-gradient(145deg, rgba(44, 24, 16, 0.95) 0%, rgba(26, 15, 10, 0.98) 100%);
            border: 1px solid rgba(212, 168, 85, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(212, 168, 85, 0.1);
        }

        .cuban-input {
            background: rgba(26, 15, 10, 0.8);
            border: 1px solid rgba(212, 168, 85, 0.3);
            color: #F5E6D3;
            transition: all 0.3s ease;
        }

        .cuban-input:focus {
            border-color: #D4A855;
            box-shadow: 0 0 0 3px rgba(212, 168, 85, 0.2);
            outline: none;
        }

        .cuban-input::placeholder {
            color: rgba(212, 168, 85, 0.4);
        }

        .cuban-button {
            background: linear-gradient(135deg, #D4A855 0%, #B8943F 100%);
            color: #2C1810;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .cuban-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #E5B966 0%, #D4A855 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 168, 85, 0.4);
        }

        .cuban-button:disabled {
            background: rgba(212, 168, 85, 0.3);
            color: rgba(44, 24, 16, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .cuban-button:focus-visible {
            outline: 2px solid #D4A855;
            outline-offset: 2px;
        }

        .cuban-button-secondary {
            background: transparent;
            border: 1px solid rgba(212, 168, 85, 0.5);
            color: #D4A855;
        }

        .cuban-button-secondary:hover:not(:disabled) {
            background: rgba(212, 168, 85, 0.1);
            border-color: #D4A855;
            transform: translateY(-1px);
        }

        .cuban-button-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
        }

        .cuban-button-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #F87171 0%, #EF4444 100%);
        }

        .tab-active {
            background: linear-gradient(135deg, rgba(212, 168, 85, 0.2) 0%, rgba(212, 168, 85, 0.1) 100%);
            border-bottom: 2px solid #D4A855;
            color: #D4A855;
        }

        .hero-overlay {
            background: linear-gradient(to bottom, rgba(26, 15, 10, 0.2) 0%, rgba(26, 15, 10, 0.5) 50%, rgba(26, 15, 10, 0.95) 100%);
        }

        .decima-verse {
            border-left: 3px solid rgba(212, 168, 85, 0.3);
            transition: all 0.3s ease;
        }

        .decima-verse:hover {
            border-left-color: #D4A855;
            background: rgba(212, 168, 85, 0.05);
        }

        .rhyme-a { color: #F87171; }
        .rhyme-b { color: #60A5FA; }
        .rhyme-c { color: #4ADE80; }
        .rhyme-d { color: #FBBF24; }

        .step-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-active {
            background: linear-gradient(135deg, #D4A855 0%, #B8943F 100%);
            color: #2C1810;
            box-shadow: 0 0 20px rgba(212, 168, 85, 0.4);
        }

        .step-complete { 
            background: #22C55E; 
            color: white; 
            animation: stepComplete 0.3s ease;
        }

        @keyframes stepComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .step-pending {
            background: rgba(212, 168, 85, 0.15);
            color: rgba(212, 168, 85, 0.5);
            border: 2px dashed rgba(212, 168, 85, 0.3);
        }

        .loading-spinner {
            border: 3px solid rgba(212, 168, 85, 0.2);
            border-top-color: #D4A855;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner-sm { width: 16px; height: 16px; border-width: 2px; }

        @keyframes spin { to { transform: rotate(360deg); } }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .poet-card {
            background: linear-gradient(145deg, rgba(44, 24, 16, 0.8) 0%, rgba(26, 15, 10, 0.9) 100%);
            border: 1px solid rgba(212, 168, 85, 0.2);
            transition: all 0.3s ease;
        }

        .poet-card:hover {
            border-color: rgba(212, 168, 85, 0.5);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .debug-panel {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(59, 130, 246, 0.5);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .debug-log-info { color: #60A5FA; }
        .debug-log-success { color: #4ADE80; }
        .debug-log-warning { color: #FBBF24; }
        .debug-log-error { color: #F87171; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-operational {
            background: rgba(34, 197, 94, 0.2);
            color: #4ADE80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .code-block {
            background: #0d0908;
            border: 1px solid rgba(212, 168, 85, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .code-header {
            background: rgba(212, 168, 85, 0.1);
            padding: 8px 16px;
            border-bottom: 1px solid rgba(212, 168, 85, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .medal-gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: #1a0f0a; }
        .medal-silver { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: #1a0f0a; }
        .medal-bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }

        /* Pulse animation for loading */
        .pulse-subtle {
            animation: pulseSub 2s ease-in-out infinite;
        }

        @keyframes pulseSub {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Focus visible for accessibility */
        button:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        a:focus-visible {
            outline: 2px solid #D4A855;
            outline-offset: 2px;
        }

        /* Skip to main content link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #D4A855;
            color: #2C1810;
            padding: 8px 16px;
            z-index: 100;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Improved mobile responsiveness */
        @media (max-width: 640px) {
            .hero-title {
                font-size: 2rem !important;
            }
            
            .step-circle {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="min-h-screen text-amber-50">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>

    <!-- Debug Toggle Button -->
    <button onclick="toggleDebugPanel()" id="debugToggle" class="fixed bottom-4 right-4 z-50 w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center shadow-lg transition-all" title="Toggle Debug Panel (Ctrl+D)" aria-label="Alternar panel de depuraci√≥n">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
        </svg>
    </button>

    <!-- Debug Panel -->
    <div id="debugPanel" class="fixed bottom-20 right-4 z-50 w-96 max-h-80 debug-panel rounded-lg overflow-hidden hidden" role="region" aria-label="Panel de depuraci√≥n">
        <div class="flex items-center justify-between p-2 bg-blue-900/50 border-b border-blue-500/30">
            <span class="text-blue-300 font-semibold">üîß Debug Console v3.3</span>
            <div class="flex gap-2">
                <button onclick="clearDebugLogs()" class="text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded hover:bg-blue-900/50">Clear</button>
                <button onclick="exportDebugLogs()" class="text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded hover:bg-blue-900/50">Export</button>
            </div>
        </div>
        <div id="debugLogs" class="p-2 max-h-64 overflow-y-auto space-y-1" aria-live="polite"></div>
    </div>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-gradient-to-b from-[#2C1810] to-[#2C1810]/95 border-b border-amber-900/30 backdrop-blur-lg">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-3xl" aria-hidden="true">üé∏</span>
                <div>
                    <h1 class="font-playfair text-xl font-bold gold-gradient">Viajera Digital</h1>
                    <p class="text-xs text-amber-200/60">El Guajiro de Hialeah ‚Ä¢ v3.3 STABLE</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="apiStatus" class="status-badge status-operational">
                    <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse" aria-hidden="true"></span>
                    <span>NoEmbed Proxy</span>
                </div>
                <button onclick="openAboutModal()" class="text-amber-200/70 hover:text-amber-200 transition-colors p-2 rounded-lg hover:bg-amber-900/30" aria-label="Acerca de">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="relative h-[45vh] min-h-[350px] flex items-center justify-center overflow-hidden" aria-label="Bienvenida">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=1920')] bg-cover bg-center opacity-25"></div>
        <div class="absolute inset-0 hero-overlay"></div>
        <div class="relative z-10 text-center px-4 max-w-4xl mx-auto pt-16">
            <div class="mb-4">
                <span class="inline-block px-4 py-1 bg-green-500/20 text-green-400 text-sm font-medium rounded-full border border-green-500/30 mb-4">
                    ‚úÖ FULLY CLIENT-SIDE ‚Ä¢ CORS FIXED
                </span>
            </div>
            <h2 class="font-playfair text-4xl md:text-5xl lg:text-6xl font-bold mb-6 gold-gradient hero-title">
                D√©cima Espinela Cubana
            </h2>
            <p class="text-lg md:text-xl text-amber-100/80 italic leading-relaxed max-w-2xl mx-auto">
                "Un algoritmo que siente la pasi√≥n del poeta,<br>
                rescata del olvido cada improvisaci√≥n,<br>
                preserva intacta la l√≠rica del coraz√≥n,<br>
                y eterniza el arte viva de la d√©cima completa."
            </p>
        </div>
    </section>

    <!-- Navigation Tabs -->
    <nav class="sticky top-[60px] z-40 bg-[#2C1810]/98 backdrop-blur-lg border-b border-amber-900/30" role="tablist" aria-label="Navegaci√≥n principal">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex overflow-x-auto">
                <button onclick="switchTab('procesar')" id="tab-procesar" class="tab-btn tab-active px-6 py-4 text-sm font-medium whitespace-nowrap transition-all flex items-center gap-2" role="tab" aria-selected="true" aria-controls="section-procesar">
                    <span aria-hidden="true">üìπ</span> Procesar Video
                </button>
                <button onclick="switchTab('decimas')" id="tab-decimas" class="tab-btn px-6 py-4 text-sm font-medium text-amber-200/60 hover:text-amber-200 whitespace-nowrap transition-all flex items-center gap-2" role="tab" aria-selected="false" aria-controls="section-decimas">
                    <span aria-hidden="true">üìú</span> D√©cimas <span id="decimasCountBadge" class="hidden px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs rounded-full">0</span>
                </button>
                <button onclick="switchTab('analisis')" id="tab-analisis" class="tab-btn px-6 py-4 text-sm font-medium text-amber-200/60 hover:text-amber-200 whitespace-nowrap transition-all flex items-center gap-2" role="tab" aria-selected="false" aria-controls="section-analisis">
                    <span aria-hidden="true">üìä</span> An√°lisis
                </button>
                <button onclick="switchTab('educacion')" id="tab-educacion" class="tab-btn px-6 py-4 text-sm font-medium text-amber-200/60 hover:text-amber-200 whitespace-nowrap transition-all flex items-center gap-2" role="tab" aria-selected="false" aria-controls="section-educacion">
                    <span aria-hidden="true">üìö</span> Educaci√≥n
                </button>
                <button onclick="switchTab('exportar')" id="tab-exportar" class="tab-btn px-6 py-4 text-sm font-medium text-amber-200/60 hover:text-amber-200 whitespace-nowrap transition-all flex items-center gap-2" role="tab" aria-selected="false" aria-controls="section-exportar">
                    <span aria-hidden="true">üì§</span> Exportar
                </button>
                <button onclick="switchTab('debug')" id="tab-debug" class="tab-btn px-6 py-4 text-sm font-medium text-blue-400/60 hover:text-blue-400 whitespace-nowrap transition-all flex items-center gap-2" role="tab" aria-selected="false" aria-controls="section-debug">
                    <span aria-hidden="true">üîß</span> Debug Info
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Section: Procesar Video -->
        <section id="section-procesar" class="tab-content" role="tabpanel" aria-labelledby="tab-procesar">
            <div class="cuban-card rounded-2xl p-6 md:p-8">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                    <h2 class="font-playfair text-2xl font-bold gold-gradient">Procesar Video de YouTube</h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-xs text-amber-200/50">API:</span>
                        <span class="status-badge status-operational text-xs">NoEmbed CORS Proxy ‚úì</span>
                        <button onclick="resetProcess()" id="resetBtn" class="hidden cuban-button-secondary cuban-button px-3 py-1 rounded-lg text-xs">
                            üîÑ Reiniciar
                        </button>
                    </div>
                </div>

                <!-- Progress Steps -->
                <div class="flex items-center justify-between mb-8 max-w-2xl mx-auto">
                    <div class="flex flex-col items-center">
                        <div id="step1-circle" class="step-circle step-active" aria-label="Paso 1: URL">1</div>
                        <span class="text-xs mt-2 text-amber-200/70">URL</span>
                    </div>
                    <div class="flex-1 h-1 bg-amber-900/30 mx-3 rounded-full overflow-hidden">
                        <div id="progress1" class="h-full bg-gradient-to-r from-amber-500 to-amber-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="step2-circle" class="step-circle step-pending" aria-label="Paso 2: Prompt">2</div>
                        <span class="text-xs mt-2 text-amber-200/70">Prompt</span>
                    </div>
                    <div class="flex-1 h-1 bg-amber-900/30 mx-3 rounded-full overflow-hidden">
                        <div id="progress2" class="h-full bg-gradient-to-r from-amber-500 to-amber-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="step3-circle" class="step-circle step-pending" aria-label="Paso 3: Resultado">3</div>
                        <span class="text-xs mt-2 text-amber-200/70">Resultado</span>
                    </div>
                </div>

                <!-- Step 1: URL Input -->
                <div id="step1-content" class="space-y-4">
                    <label for="youtubeUrl" class="block text-amber-200/80 font-medium mb-2">
                        Paso 1: Ingresa el enlace del video de YouTube
                    </label>
                    <div class="flex gap-3 flex-col sm:flex-row">
                        <div class="relative flex-1">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-amber-200/40" aria-hidden="true">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
                                </svg>
                            </span>
                            <input type="url" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=..." class="cuban-input w-full pl-12 pr-4 py-3 rounded-xl text-lg" aria-describedby="urlHelp">
                        </div>
                        <button onclick="validateYouTube()" id="validateBtn" class="cuban-button px-6 py-3 rounded-xl flex items-center gap-2 min-w-[140px] justify-center">
                            <span>Validar</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>

                    <div id="urlHelp" class="mt-4 p-4 bg-amber-900/20 rounded-xl border border-amber-900/30">
                        <p class="text-sm text-amber-200/60 mb-2">üß™ URLs de prueba r√°pida:</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="fillTestUrl('https://www.youtube.com/watch?v=dQw4w9WgXcQ')" class="text-xs px-3 py-1.5 bg-amber-900/40 hover:bg-amber-900/60 text-amber-300 rounded-lg transition-colors">Test Video 1</button>
                            <button onclick="fillTestUrl('https://youtu.be/jNQXAC9IVRw')" class="text-xs px-3 py-1.5 bg-amber-900/40 hover:bg-amber-900/60 text-amber-300 rounded-lg transition-colors">Test Video 2</button>
                            <button onclick="fillTestUrl('https://www.youtube.com/watch?v=8jPQjjsBbIc')" class="text-xs px-3 py-1.5 bg-amber-900/40 hover:bg-amber-900/60 text-amber-300 rounded-lg transition-colors">Test Video 3</button>
                        </div>
                    </div>

                    <!-- Validation Error -->
                    <div id="validationError" class="hidden mt-4 p-4 bg-red-900/20 rounded-xl border border-red-500/30 fade-in" role="alert">
                        <div class="flex items-start gap-3">
                            <span class="text-red-400 text-xl" aria-hidden="true">‚ö†Ô∏è</span>
                            <div class="flex-1">
                                <p class="font-semibold text-red-300">Error de Validaci√≥n</p>
                                <p id="validationErrorText" class="text-sm text-red-200/70 mt-1"></p>
                            </div>
                            <button onclick="hideValidationError()" class="text-red-400 hover:text-red-300" aria-label="Cerrar error">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Video Preview -->
                    <div id="videoPreview" class="hidden mt-6 p-5 bg-gradient-to-r from-amber-900/30 to-amber-800/20 rounded-xl border border-amber-500/30 fade-in">
                        <div class="flex gap-4 flex-col sm:flex-row">
                            <div class="relative flex-shrink-0">
                                <img id="videoThumbnail" src="" alt="Miniatura del video" class="w-full sm:w-48 h-28 object-cover rounded-lg bg-amber-900/30">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="w-12 h-12 rounded-full bg-red-600/90 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 id="videoTitle" class="font-semibold text-amber-100 mb-2 line-clamp-2"></h3>
                                <p id="videoChannel" class="text-sm text-amber-200/60 mb-1 flex items-center gap-2">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    <span class="truncate"></span>
                                </p>
                                <p id="videoId" class="text-xs text-amber-200/40 font-mono"></p>
                            </div>
                            <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                <span class="px-3 py-1 bg-green-500/20 text-green-400 text-sm rounded-full flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    V√°lido
                                </span>
                            </div>
                        </div>
                        <button onclick="goToStep(2)" class="cuban-button w-full py-3 rounded-xl mt-4 flex items-center justify-center gap-2">
                            <span>Continuar al Paso 2</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Prompt -->
                <div id="step2-content" class="hidden space-y-4 fade-in">
                    <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                        <label class="block text-amber-200/80 font-medium">Paso 2: Copia el prompt para Perplexity Pro</label>
                        <button onclick="goToStep(1)" class="text-amber-200/60 hover:text-amber-200 text-sm flex items-center gap-1 px-3 py-1 rounded-lg hover:bg-amber-900/30 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Volver
                        </button>
                    </div>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="text-amber-300 text-sm font-medium">üìã Prompt Generado</span>
                            <button onclick="copyPrompt()" id="copyPromptBtn" class="cuban-button px-4 py-1.5 rounded-lg text-sm flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                <span>Copiar</span>
                            </button>
                        </div>
                        <pre id="promptText" class="p-4 text-sm text-amber-100/90 whitespace-pre-wrap font-mono max-h-72 overflow-y-auto"></pre>
                    </div>
                    
                    <div class="bg-blue-900/20 rounded-xl p-5 border border-blue-500/30 mt-4">
                        <h4 class="font-semibold text-blue-300 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Instrucciones
                        </h4>
                        <ol class="text-sm text-blue-200/80 space-y-2">
                            <li class="flex items-start gap-2">
                                <span class="w-6 h-6 rounded-full bg-blue-500/20 text-blue-300 flex items-center justify-center flex-shrink-0 text-xs font-bold">1</span>
                                <span>Haz clic en "Copiar" arriba.</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-6 h-6 rounded-full bg-blue-500/20 text-blue-300 flex items-center justify-center flex-shrink-0 text-xs font-bold">2</span>
                                <span>Ve a <a href="https://www.perplexity.ai" target="_blank" rel="noopener noreferrer" class="underline hover:text-blue-300 font-medium">Perplexity Pro ‚Üó</a></span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-6 h-6 rounded-full bg-blue-500/20 text-blue-300 flex items-center justify-center flex-shrink-0 text-xs font-bold">3</span>
                                <span>Pega el prompt y espera la respuesta.</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-6 h-6 rounded-full bg-blue-500/20 text-blue-300 flex items-center justify-center flex-shrink-0 text-xs font-bold">4</span>
                                <span>Copia TODO el texto de respuesta y p√©galo en el Paso 3.</span>
                            </li>
                        </ol>
                    </div>
                    <button onclick="goToStep(3)" class="cuban-button w-full py-3 rounded-xl mt-4 flex items-center justify-center gap-2">
                        <span>Continuar al Paso 3</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                        </svg>
                    </button>
                </div>

                <!-- Step 3: Result -->
                <div id="step3-content" class="hidden space-y-4 fade-in">
                    <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                        <label for="perplexityResult" class="block text-amber-200/80 font-medium">Paso 3: Pega el resultado de Perplexity</label>
                        <button onclick="goToStep(2)" class="text-amber-200/60 hover:text-amber-200 text-sm flex items-center gap-1 px-3 py-1 rounded-lg hover:bg-amber-900/30 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Volver
                        </button>
                    </div>
                    <div class="relative">
                        <textarea id="perplexityResult" rows="14" placeholder="Pega aqu√≠ la respuesta completa de Perplexity Pro..." class="cuban-input w-full px-4 py-3 rounded-xl resize-none" aria-describedby="charCountInfo"></textarea>
                        <div id="charCountInfo" class="absolute bottom-3 right-3 text-xs text-amber-200/40">
                            <span id="charCount">0</span> caracteres
                        </div>
                    </div>
                    <div class="flex gap-3 flex-col sm:flex-row">
                        <button onclick="loadSampleData()" class="cuban-button-secondary cuban-button px-4 py-3 rounded-xl flex items-center justify-center gap-2 sm:flex-1">
                            <span>üì¶</span> Cargar Demo
                        </button>
                        <button onclick="processResult()" id="processBtn" class="cuban-button px-6 py-3 rounded-xl flex items-center justify-center gap-2 sm:flex-[2]">
                            <span>üöÄ</span>
                            <span>Procesar D√©cimas</span>
                        </button>
                    </div>
                </div>

                <!-- Processing Status -->
                <div id="processingStatus" class="hidden mt-6 fade-in" role="status" aria-live="polite">
                    <div class="bg-amber-900/20 rounded-xl p-5 border border-amber-500/30">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="loading-spinner" aria-hidden="true"></div>
                            <div>
                                <p id="processingText" class="font-medium text-amber-200">Procesando...</p>
                                <p id="processingSubtext" class="text-sm text-amber-200/60">Esto puede tomar unos segundos</p>
                            </div>
                        </div>
                        <div class="w-full bg-amber-900/50 rounded-full h-2 overflow-hidden">
                            <div id="processingProgress" class="h-full bg-gradient-to-r from-amber-500 to-amber-400 rounded-full transition-all duration-300 pulse-subtle" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Success Message -->
                <div id="successMessage" class="hidden mt-6 slide-up" role="alert">
                    <div class="bg-gradient-to-r from-green-900/30 to-green-800/20 rounded-xl p-5 border border-green-500/30">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-green-300 text-lg">¬°Procesamiento exitoso!</p>
                                <p id="successDetails" class="text-sm text-green-200/70 mt-1"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                            <button onclick="switchTab('decimas')" class="cuban-button py-3 rounded-xl flex items-center justify-center gap-2">
                                <span aria-hidden="true">üìú</span> Ver D√©cimas
                            </button>
                            <button onclick="switchTab('analisis')" class="cuban-button-secondary cuban-button py-3 rounded-xl flex items-center justify-center gap-2">
                                <span aria-hidden="true">üìä</span> Ver An√°lisis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: D√©cimas -->
        <section id="section-decimas" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-decimas">
            <div class="cuban-card rounded-2xl p-6 md:p-8">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                    <h2 class="font-playfair text-2xl font-bold gold-gradient">D√©cimas Extra√≠das</h2>
                    <div id="decimasCount" class="px-4 py-1.5 bg-amber-900/30 text-amber-200/70 text-sm rounded-full font-medium">
                        0 d√©cimas
                    </div>
                </div>
                <div id="noDecimasMessage" class="text-center py-16 text-amber-200/50">
                    <div class="text-5xl mb-4" aria-hidden="true">üìú</div>
                    <p class="text-lg mb-2 font-medium">No hay d√©cimas procesadas</p>
                    <p class="text-sm mb-4">Procesa un video de YouTube para ver las d√©cimas aqu√≠</p>
                    <button onclick="switchTab('procesar')" class="cuban-button px-6 py-2 rounded-lg text-sm">
                        Ir a Procesar Video
                    </button>
                </div>
                <div id="decimasList" class="space-y-6 hidden"></div>
            </div>
        </section>

        <!-- Section: An√°lisis -->
        <section id="section-analisis" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-analisis">
            <div class="cuban-card rounded-2xl p-6 md:p-8">
                <h2 class="font-playfair text-2xl font-bold gold-gradient mb-6">An√°lisis Literario</h2>
                <div id="noAnalysisMessage" class="text-center py-16 text-amber-200/50">
                    <div class="text-5xl mb-4" aria-hidden="true">üìä</div>
                    <p class="text-lg mb-2 font-medium">No hay an√°lisis disponible</p>
                    <p class="text-sm mb-4">Procesa un video primero para generar el an√°lisis</p>
                    <button onclick="switchTab('procesar')" class="cuban-button px-6 py-2 rounded-lg text-sm">
                        Ir a Procesar Video
                    </button>
                </div>
                <div id="analysisContent" class="hidden space-y-6">
                    <!-- Video Info -->
                    <div id="analysisVideoInfo" class="bg-amber-900/20 rounded-xl p-4 border border-amber-900/30 flex items-center gap-4 flex-wrap">
                        <img id="analysisVideoThumb" src="" alt="" class="w-24 h-16 object-cover rounded-lg hidden">
                        <div class="flex-1 min-w-0">
                            <p id="analysisVideoTitle" class="font-medium text-amber-100 truncate"></p>
                            <p id="analysisVideoMeta" class="text-sm text-amber-200/60"></p>
                        </div>
                    </div>
                    
                    <!-- Top 3 D√©cimas -->
                    <div class="bg-gradient-to-r from-amber-900/40 to-amber-800/30 rounded-xl p-6 border border-amber-500/40">
                        <h3 class="font-playfair text-xl font-semibold text-amber-300 mb-5 flex items-center gap-3">
                            <span class="text-2xl" aria-hidden="true">üèÜ</span> Las 3 Mejores D√©cimas
                        </h3>
                        <div id="topThreeDecimas" class="space-y-4"></div>
                    </div>
                    
                    <!-- Analysis Grid -->
                    <div class="grid md:grid-cols-2 gap-5">
                        <div class="bg-amber-900/20 rounded-xl p-5 border border-amber-900/30">
                            <h4 class="font-semibold text-amber-300 mb-3 flex items-center gap-2">
                                <span aria-hidden="true">üé≠</span> Temas Recurrentes
                            </h4>
                            <p id="analysisThemes" class="text-amber-100/80 text-sm leading-relaxed"></p>
                        </div>
                        <div class="bg-amber-900/20 rounded-xl p-5 border border-amber-900/30">
                            <h4 class="font-semibold text-amber-300 mb-3 flex items-center gap-2">
                                <span aria-hidden="true">üó£Ô∏è</span> Regionalismos
                            </h4>
                            <p id="analysisRegionalisms" class="text-amber-100/80 text-sm leading-relaxed"></p>
                        </div>
                        <div class="bg-amber-900/20 rounded-xl p-5 border border-amber-900/30">
                            <h4 class="font-semibold text-amber-300 mb-3 flex items-center gap-2">
                                <span aria-hidden="true">‚ú®</span> Sofisticaci√≥n Ling√º√≠stica
                            </h4>
                            <p id="analysisLinguistic" class="text-amber-100/80 text-sm leading-relaxed"></p>
                        </div>
                        <div class="bg-amber-900/20 rounded-xl p-5 border border-amber-900/30">
                            <h4 class="font-semibold text-amber-300 mb-3 flex items-center gap-2">
                                <span aria-hidden="true">üé™</span> T√©cnicas de Improvisaci√≥n
                            </h4>
                            <p id="analysisTechniques" class="text-amber-100/80 text-sm leading-relaxed"></p>
                        </div>
                    </div>
                    
                    <!-- Cultural Significance -->
                    <div class="bg-gradient-to-r from-purple-900/30 to-indigo-900/20 rounded-xl p-6 border border-purple-500/30">
                        <h4 class="font-semibold text-purple-300 mb-3 flex items-center gap-2">
                            <span aria-hidden="true">üå¥</span> Significado Cultural
                        </h4>
                        <p id="analysisCultural" class="text-purple-100/80 leading-relaxed"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Educaci√≥n -->
        <section id="section-educacion" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-educacion">
            <div class="cuban-card rounded-2xl p-6 md:p-8">
                <h2 class="font-playfair text-2xl font-bold gold-gradient mb-2">Maestros de la D√©cima</h2>
                <p class="text-amber-200/60 mb-6">Conoce a los grandes exponentes de la d√©cima cubana</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="poetsGrid"></div>
                
                <!-- Additional Educational Content -->
                <div class="mt-8 p-6 bg-amber-900/20 rounded-xl border border-amber-900/30">
                    <h3 class="font-playfair text-xl font-semibold gold-gradient mb-4">¬øQu√© es la D√©cima Espinela?</h3>
                    <p class="text-amber-100/80 leading-relaxed mb-4">
                        La d√©cima espinela es una estrofa de diez versos octos√≠labos con rima consonante siguiendo el esquema <span class="font-mono text-amber-400">ABBAACCDDC</span>. 
                        Fue creada por Vicente Espinel en el siglo XVI y se convirti√≥ en la forma po√©tica preferida del campesinado cubano.
                    </p>
                    <div class="grid sm:grid-cols-2 gap-4 mt-4">
                        <div class="bg-amber-900/30 rounded-lg p-4">
                            <h4 class="font-semibold text-amber-300 mb-2">Estructura</h4>
                            <ul class="text-sm text-amber-200/70 space-y-1">
                                <li>‚Ä¢ 10 versos por estrofa</li>
                                <li>‚Ä¢ 8 s√≠labas por verso</li>
                                <li>‚Ä¢ Rima: ABBAACCDDC</li>
                            </ul>
                        </div>
                        <div class="bg-amber-900/30 rounded-lg p-4">
                            <h4 class="font-semibold text-amber-300 mb-2">Caracter√≠sticas</h4>
                            <ul class="text-sm text-amber-200/70 space-y-1">
                                <li>‚Ä¢ Tradici√≥n oral</li>
                                <li>‚Ä¢ Improvisaci√≥n (repentismo)</li>
                                <li>‚Ä¢ Controversias po√©ticas</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Exportar -->
        <section id="section-exportar" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-exportar">
            <div class="cuban-card rounded-2xl p-6 md:p-8">
                <h2 class="font-playfair text-2xl font-bold gold-gradient mb-6">Exportar y Compartir</h2>
                <div id="noExportMessage" class="text-center py-16 text-amber-200/50">
                    <div class="text-5xl mb-4" aria-hidden="true">üì§</div>
                    <p class="text-lg mb-2 font-medium">No hay contenido para exportar</p>
                    <p class="text-sm mb-4">Procesa un video primero</p>
                    <button onclick="switchTab('procesar')" class="cuban-button px-6 py-2 rounded-lg text-sm">
                        Ir a Procesar Video
                    </button>
                </div>
                <div id="exportOptions" class="hidden">
                    <div class="grid md:grid-cols-2 gap-5">
                        <button onclick="exportAsPDF()" class="bg-amber-900/20 rounded-xl p-6 border border-amber-900/30 hover:border-amber-500/50 transition-all text-left group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-lg bg-red-500/20 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform" aria-hidden="true">üìÑ</div>
                                <div>
                                    <h3 class="font-semibold text-amber-100 mb-1">Exportar como PDF</h3>
                                    <p class="text-sm text-amber-200/60">Formateado para impresi√≥n</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="exportAsText()" class="bg-amber-900/20 rounded-xl p-6 border border-amber-900/30 hover:border-amber-500/50 transition-all text-left group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform" aria-hidden="true">üìù</div>
                                <div>
                                    <h3 class="font-semibold text-amber-100 mb-1">Exportar como Texto</h3>
                                    <p class="text-sm text-amber-200/60">Archivo plano (.txt)</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="exportAsJSON()" class="bg-amber-900/20 rounded-xl p-6 border border-amber-900/30 hover:border-amber-500/50 transition-all text-left group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform" aria-hidden="true">{ }</div>
                                <div>
                                    <h3 class="font-semibold text-amber-100 mb-1">Exportar como JSON</h3>
                                    <p class="text-sm text-amber-200/60">Datos estructurados</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="exportAsMarkdown()" class="bg-amber-900/20 rounded-xl p-6 border border-amber-900/30 hover:border-amber-500/50 transition-all text-left group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform" aria-hidden="true">üìã</div>
                                <div>
                                    <h3 class="font-semibold text-amber-100 mb-1">Exportar como Markdown</h3>
                                    <p class="text-sm text-amber-200/60">Para documentaci√≥n</p>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Clear Data Option -->
                    <div class="mt-6 p-4 bg-red-900/10 rounded-xl border border-red-500/20">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div>
                                <h4 class="font-medium text-red-300">Borrar Datos</h4>
                                <p class="text-sm text-red-200/60">Elimina todas las d√©cimas y an√°lisis guardados</p>
                            </div>
                            <button onclick="clearAllData()" class="cuban-button-danger cuban-button px-4 py-2 rounded-lg text-sm">
                                üóëÔ∏è Borrar Todo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Debug -->
        <section id="section-debug" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-debug">
            <div class="cuban-card rounded-2xl p-6 md:p-8">
                <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                    <h2 class="font-playfair text-2xl font-bold text-blue-400">üîß Debug Information</h2>
                    <span class="text-xs text-blue-300/60 font-mono">v3.3.0-stable</span>
                </div>
                
                <!-- System Status -->
                <div class="bg-green-900/20 rounded-xl p-5 border border-green-500/30 mb-6">
                    <h3 class="font-semibold text-green-400 mb-3 flex items-center gap-2">‚úÖ System Status: Operational</h3>
                    <p class="text-sm text-green-200/70">Using <strong>NoEmbed</strong> proxy for client-side CORS resolution. All operations run directly in the browser.</p>
                </div>

                <!-- App State -->
                <div class="bg-[#0d0908] rounded-xl border border-amber-900/30 overflow-hidden mb-6">
                    <div class="bg-amber-900/30 px-4 py-2 border-b border-amber-900/30 flex items-center justify-between">
                        <span class="text-amber-300 font-medium text-sm">Current App State</span>
                        <button onclick="copyAppState()" class="text-xs text-amber-400 hover:text-amber-300 px-2 py-1 rounded hover:bg-amber-900/30">Copy JSON</button>
                    </div>
                    <pre id="appStateDebug" class="p-4 text-xs font-mono text-amber-100/80 overflow-x-auto max-h-64"></pre>
                </div>

                <!-- Performance Metrics -->
                <div class="bg-amber-900/20 rounded-xl p-5 border border-amber-900/30">
                    <h4 class="font-medium text-amber-300 mb-4">Performance Metrics</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-3 bg-amber-900/30 rounded-lg">
                            <p id="metricValidation" class="text-2xl font-bold text-amber-400">--</p>
                            <p class="text-xs text-amber-200/60 mt-1">Validation Time</p>
                        </div>
                        <div class="text-center p-3 bg-amber-900/30 rounded-lg">
                            <p id="metricProcessing" class="text-2xl font-bold text-amber-400">--</p>
                            <p class="text-xs text-amber-200/60 mt-1">Processing Time</p>
                        </div>
                        <div class="text-center p-3 bg-amber-900/30 rounded-lg">
                            <p id="metricDecimas" class="text-2xl font-bold text-amber-400">0</p>
                            <p class="text-xs text-amber-200/60 mt-1">D√©cimas Parsed</p>
                        </div>
                        <div class="text-center p-3 bg-amber-900/30 rounded-lg">
                            <p id="metricErrors" class="text-2xl font-bold text-green-400">0</p>
                            <p class="text-xs text-amber-200/60 mt-1">Errors</p>
                        </div>
                    </div>
                </div>

                <!-- API Test -->
                <div class="mt-6 bg-blue-900/20 rounded-xl p-5 border border-blue-500/30">
                    <h4 class="font-medium text-blue-300 mb-3">API Connection Test</h4>
                    <button onclick="testAPIConnection()" id="testApiBtn" class="cuban-button px-4 py-2 rounded-lg text-sm">
                        üîó Test NoEmbed Connection
                    </button>
                    <p id="apiTestResult" class="mt-3 text-sm text-blue-200/70"></p>
                </div>
            </div>
        </section>
    </main>

    <!-- About Modal -->
    <div id="aboutModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="aboutModalTitle">
        <div class="cuban-card max-w-2xl mx-4 rounded-2xl p-8 relative max-h-[85vh] overflow-y-auto">
            <button onclick="closeAboutModal()" class="absolute top-4 right-4 text-amber-200/60 hover:text-amber-200 p-1" aria-label="Cerrar modal">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <h2 id="aboutModalTitle" class="font-playfair text-2xl font-bold gold-gradient mb-4">Acerca de Viajera Digital</h2>
            <div class="space-y-4 text-amber-100/80">
                <p><strong>Viajera Digital</strong> es una herramienta para transcribir y analizar la <strong>d√©cima espinela cubana</strong> a partir de videos de YouTube.</p>
                
                <div class="bg-green-900/20 rounded-xl p-4 border border-green-500/30">
                    <h3 class="font-semibold text-green-400 mb-2">‚úÖ v3.3 - Stable Release</h3>
                    <ul class="text-sm text-green-200/70 space-y-1">
                        <li>‚Ä¢ Proxy CORS integrado (NoEmbed)</li>
                        <li>‚Ä¢ Funciona en cualquier navegador sin servidor</li>
                        <li>‚Ä¢ Parsing mejorado con Regex robustos</li>
                        <li>‚Ä¢ Protecci√≥n XSS con textContent</li>
                        <li>‚Ä¢ Accesibilidad mejorada (ARIA)</li>
                        <li>‚Ä¢ Mejor responsive design</li>
                    </ul>
                </div>
                
                <div class="bg-amber-900/20 rounded-xl p-4 border border-amber-900/30">
                    <h3 class="font-semibold text-amber-300 mb-2">C√≥mo funciona</h3>
                    <ol class="text-sm text-amber-200/70 space-y-1 list-decimal list-inside">
                        <li>Ingresa un enlace de YouTube con d√©cimas cubanas</li>
                        <li>Copia el prompt generado a Perplexity Pro</li>
                        <li>Pega la respuesta de Perplexity aqu√≠</li>
                        <li>Visualiza y exporta las d√©cimas extra√≠das</li>
                    </ol>
                </div>
                
                <p class="text-sm text-amber-200/60 italic border-l-2 border-amber-500/30 pl-4">"En memoria de Calixto Gonz√°lez, maestro cuya pasi√≥n por la d√©cima inspir√≥ a generaciones."</p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg opacity-0 transition-all duration-300 pointer-events-none z-50 flex items-center gap-3" role="alert" aria-live="polite">
        <span id="toastIcon" aria-hidden="true"></span>
        <span id="toastMessage">Mensaje</span>
    </div>

<script>
// ========================================
// APP STATE
// ========================================
const state = {
    currentVideo: null,
    decimas: [],
    analysis: null,
    currentStep: 1,
    metrics: { 
        validationTime: null, 
        processingTime: null, 
        errorCount: 0,
        sessionStart: Date.now()
    },
    debugLogs: []
};

// ========================================
// DEBUG FUNCTIONS
// ========================================
function debugLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = { timestamp, message, type };
    state.debugLogs.push(logEntry);
    
    // Limit log size to prevent memory issues
    if (state.debugLogs.length > 500) {
        state.debugLogs = state.debugLogs.slice(-250);
    }
    
    const logsContainer = document.getElementById('debugLogs');
    if (logsContainer) {
        const logDiv = document.createElement('div');
        logDiv.className = `debug-log-${type}`;
        logDiv.textContent = `[${timestamp}] ${message}`;
        logsContainer.appendChild(logDiv);
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }
    console.log(`[${type.toUpperCase()}] ${message}`);
    updateAppStateDebug();
}

function toggleDebugPanel() {
    const panel = document.getElementById('debugPanel');
    panel.classList.toggle('hidden');
    debugLog('Debug panel toggled', 'info');
}

function clearDebugLogs() {
    state.debugLogs = [];
    const logsContainer = document.getElementById('debugLogs');
    if (logsContainer) logsContainer.innerHTML = '';
    debugLog('Debug logs cleared', 'info');
}

function exportDebugLogs() {
    const logs = state.debugLogs.map(l => `[${l.timestamp}] [${l.type.toUpperCase()}] ${l.message}`).join('\n');
    const header = `Viajera Digital Debug Logs\nExported: ${new Date().toISOString()}\nSession Duration: ${Math.round((Date.now() - state.metrics.sessionStart) / 1000)}s\n${'='.repeat(50)}\n\n`;
    downloadFile('viajera-debug-logs.txt', header + logs, 'text/plain');
    showToast('Logs exportados', 'success');
}

function updateAppStateDebug() {
    const stateDisplay = document.getElementById('appStateDebug');
    if (stateDisplay) {
        const displayState = {
            currentVideo: state.currentVideo ? {
                id: state.currentVideo.id,
                title: state.currentVideo.title?.substring(0, 50) + '...',
                author: state.currentVideo.author
            } : null,
            decimasCount: state.decimas.length,
            hasAnalysis: !!state.analysis,
            currentStep: state.currentStep,
            metrics: state.metrics,
            logCount: state.debugLogs.length
        };
        stateDisplay.textContent = JSON.stringify(displayState, null, 2);
    }
    
    // Update metrics display
    document.getElementById('metricDecimas').textContent = state.decimas.length;
    document.getElementById('metricErrors').textContent = state.metrics.errorCount;
    document.getElementById('metricErrors').className = state.metrics.errorCount > 0 
        ? 'text-2xl font-bold text-red-400' 
        : 'text-2xl font-bold text-green-400';
}

function copyAppState() {
    const fullState = {
        ...state,
        exportedAt: new Date().toISOString(),
        userAgent: navigator.userAgent
    };
    navigator.clipboard.writeText(JSON.stringify(fullState, null, 2))
        .then(() => showToast('Estado copiado al portapapeles', 'success'))
        .catch(() => showToast('Error al copiar', 'error'));
}

async function testAPIConnection() {
    const btn = document.getElementById('testApiBtn');
    const result = document.getElementById('apiTestResult');
    
    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner loading-spinner-sm inline-block mr-2"></div> Testing...';
    result.textContent = '';
    
    try {
        const startTime = performance.now();
        const response = await fetch('https://noembed.com/embed?url=https://www.youtube.com/watch?v=dQw4w9WgXcQ');
        const data = await response.json();
        const elapsed = Math.round(performance.now() - startTime);
        
        if (data.title) {
            result.innerHTML = `<span class="text-green-400">‚úÖ Connection successful!</span><br>Response time: ${elapsed}ms<br>Test video: "${data.title}"`;
            debugLog(`API test passed in ${elapsed}ms`, 'success');
        } else {
            throw new Error('Invalid response');
        }
    } catch (error) {
        result.innerHTML = `<span class="text-red-400">‚ùå Connection failed: ${error.message}</span>`;
        debugLog(`API test failed: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîó Test NoEmbed Connection';
    }
}

// ========================================
// DATA
// ========================================
const poets = [
    { name: "Jes√∫s Orta Ruiz", years: "1922-2005", bio: "El Indio Nabor√≠. Premio Nacional de Literatura 1995. M√°ximo exponente de la d√©cima cubana.", specialty: "Repentismo", image: "üé≠" },
    { name: "Chanito Isidr√≥n", years: "1932-2014", bio: "Maestro del ingenio r√°pido y guardi√°n de la tradici√≥n campesina cubana.", specialty: "Punto guajiro", image: "üé∏" },
    { name: "Tomasita Quiala", years: "1937-", bio: "La reina del repentismo. Voz valiente que abri√≥ camino a la d√©cima femenina.", specialty: "Controversia", image: "üë©" },
    { name: "Alexis D√≠az Pimienta", years: "1966-", bio: "Poeta, novelista y te√≥rico. Llev√≥ la d√©cima cubana a escenarios internacionales.", specialty: "Teor√≠a", image: "üìö" },
    { name: "Luis Paz (Papillo)", years: "1946-2018", bio: "Virtuoso del punto libre con una voz inconfundible y estilo √∫nico.", specialty: "Punto libre", image: "üé§" },
    { name: "Calixto Gonz√°lez", years: "1952-2023", bio: "Maestro cuya pasi√≥n y dedicaci√≥n inspir√≥ a generaciones de decimistas.", specialty: "Punto fijo", image: "‚≠ê" }
];

const sampleDecimas = [
    { 
        poet: "Juan Antonio D√≠az", 
        number: 1, 
        verses: [
            "En esta tierra bendita",
            "donde el sol brilla radiante,",
            "se oye el canto del amante",
            "que su pasi√≥n no limita.",
            "La d√©cima se recita",
            "con amor y con fervor,",
            "porque en ella est√° el valor",
            "de nuestra cultura viva,",
            "que aunque el tiempo nos derriba",
            "siempre renace mejor."
        ],
        rhymeScheme: "ABBAACCDDC",
        analysis: { 
            technicalMastery: "Excelente dominio del octos√≠labo con acentuaci√≥n perfecta.", 
            poeticDevices: "Uso de met√°fora solar y personificaci√≥n de la d√©cima.", 
            culturalElements: "Referencias a la tradici√≥n oral campesina cubana." 
        } 
    },
    { 
        poet: "Mar√≠a del Carmen", 
        number: 2, 
        verses: [
            "Cuando el guajiro canta",
            "la noche se hace d√≠a,",
            "porque su melod√≠a",
            "al coraz√≥n levanta.",
            "Su voz que nos encanta",
            "viene del monte verde,",
            "y el que la escucha pierde",
            "toda la pena que siente,",
            "porque el canto es la fuente",
            "donde el alma se enverde."
        ],
        rhymeScheme: "ABBAACCDDC",
        analysis: { 
            technicalMastery: "Buen manejo de la estructura espinela.", 
            poeticDevices: "Ant√≠tesis noche/d√≠a, sinestesia.", 
            culturalElements: "El guajiro como s√≠mbolo cultural." 
        } 
    }
];

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    debugLog('Viajera Digital v3.3 STABLE initialized', 'success');
    debugLog('Using NoEmbed Proxy for CORS bypass', 'info');
    debugLog(`User Agent: ${navigator.userAgent.substring(0, 50)}...`, 'info');
    
    renderPoets();
    updateAppStateDebug();

    // Character counter for textarea
    const textarea = document.getElementById('perplexityResult');
    textarea.addEventListener('input', (e) => {
        const count = e.target.value.length;
        document.getElementById('charCount').textContent = count.toLocaleString();
    });

    // Enter key to validate
    document.getElementById('youtubeUrl').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            validateYouTube();
        }
    });

    // Load saved data
    loadFromLocalStorage();
    
    // Close modal on backdrop click
    document.getElementById('aboutModal').addEventListener('click', (e) => {
        if (e.target.id === 'aboutModal') closeAboutModal();
    });
});

// ========================================
// NAVIGATION
// ========================================
function switchTab(tabName) {
    debugLog(`Switching to tab: ${tabName}`, 'info');
    
    // Hide all sections
    document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
    
    // Reset all tab buttons
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('tab-active');
        b.classList.add('text-amber-200/60');
        b.setAttribute('aria-selected', 'false');
    });
    
    // Show selected section
    const section = document.getElementById(`section-${tabName}`);
    if (section) {
        section.classList.remove('hidden');
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Activate tab button
    const activeTab = document.getElementById(`tab-${tabName}`);
    if (activeTab) {
        activeTab.classList.add('tab-active');
        activeTab.classList.remove('text-amber-200/60');
        activeTab.setAttribute('aria-selected', 'true');
    }
}

// ========================================
// YOUTUBE VALIDATION (CORS FIXED via NoEmbed)
// ========================================
async function validateYouTube() {
    const urlInput = document.getElementById('youtubeUrl');
    const url = urlInput.value.trim();
    debugLog(`Validating URL: ${url}`, 'info');

    // Basic validation
    if (!url) {
        return showValidationError('Por favor, ingresa un enlace de YouTube.');
    }
    
    const videoId = extractVideoId(url);
    if (!videoId) {
        return showValidationError('El enlace no parece ser una URL v√°lida de YouTube. Formatos aceptados: youtube.com/watch?v=..., youtu.be/..., youtube.com/embed/...');
    }

    const btn = document.getElementById('validateBtn');
    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner loading-spinner-sm"></div><span class="ml-2">Validando...</span>';
    
    const startTime = performance.now();

    try {
        debugLog('Calling NoEmbed proxy API...', 'info');
        const proxyUrl = `https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`;
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
        
        const response = await fetch(proxyUrl, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }
        
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        if (!data.title) {
            throw new Error('Video no encontrado o no disponible');
        }

        // Success!
        state.metrics.validationTime = Math.round(performance.now() - startTime);
        document.getElementById('metricValidation').textContent = `${state.metrics.validationTime}ms`;
        debugLog(`Validation successful in ${state.metrics.validationTime}ms`, 'success');

        state.currentVideo = {
            id: videoId,
            title: data.title || 'Sin t√≠tulo',
            author: data.author_name || 'Desconocido',
            thumbnail: data.thumbnail_url || `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
            url: url
        };

        // Update UI with textContent for security
        document.getElementById('videoThumbnail').src = state.currentVideo.thumbnail;
        document.getElementById('videoThumbnail').alt = `Miniatura de ${state.currentVideo.title}`;
        document.getElementById('videoTitle').textContent = state.currentVideo.title;
        document.getElementById('videoChannel').querySelector('span').textContent = state.currentVideo.author;
        document.getElementById('videoId').textContent = `ID: ${videoId}`;
        
        document.getElementById('videoPreview').classList.remove('hidden');
        document.getElementById('resetBtn').classList.remove('hidden');
        hideValidationError();
        
        // Update progress
        document.getElementById('progress1').style.width = '100%';
        document.getElementById('step1-circle').classList.remove('step-active');
        document.getElementById('step1-circle').classList.add('step-complete');
        document.getElementById('step1-circle').textContent = '‚úì';
        
        showToast('¬°Video validado correctamente!', 'success');
        saveToLocalStorage();

    } catch (error) {
        debugLog(`Validation error: ${error.message}`, 'error');
        state.metrics.errorCount++;
        updateAppStateDebug();
        
        let errorMessage = 'No se pudo acceder al video.';
        if (error.name === 'AbortError') {
            errorMessage = 'Tiempo de espera agotado. Verifica tu conexi√≥n.';
        } else if (error.message.includes('not found') || error.message.includes('no encontrado')) {
            errorMessage = 'El video no existe o es privado.';
        }
        
        showValidationError(errorMessage);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>Validar</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
    }
}

function extractVideoId(url) {
    if (!url) return null;
    
    // Clean the URL
    url = url.trim();
    
    // Multiple patterns for YouTube URLs
    const patterns = [
        /(?:youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})/,
        /(?:youtu\.be\/)([a-zA-Z0-9_-]{11})/,
        /(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /(?:youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
        /(?:youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/,
        /^([a-zA-Z0-9_-]{11})$/ // Just the ID
    ];
    
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
            return match[1];
        }
    }
    
    return null;
}

function showValidationError(msg) {
    const errorEl = document.getElementById('validationError');
    document.getElementById('validationErrorText').textContent = msg;
    errorEl.classList.remove('hidden');
    errorEl.focus();
    debugLog(`Validation error shown: ${msg}`, 'warning');
}

function hideValidationError() {
    document.getElementById('validationError').classList.add('hidden');
}

function fillTestUrl(url) { 
    document.getElementById('youtubeUrl').value = url;
    document.getElementById('youtubeUrl').focus();
}

function goToStep(step) {
    state.currentStep = step;
    debugLog(`Moving to step ${step}`, 'info');
    
    // Hide all step contents
    document.querySelectorAll('[id^="step"][id$="-content"]').forEach(el => el.classList.add('hidden'));
    
    // Show current step
    const currentContent = document.getElementById(`step${step}-content`);
    if (currentContent) {
        currentContent.classList.remove('hidden');
    }
    
    // Update step circles
    for (let i = 1; i <= 3; i++) {
        const circle = document.getElementById(`step${i}-circle`);
        if (circle) {
            circle.classList.remove('step-active', 'step-complete', 'step-pending');
            if (i < step) {
                circle.classList.add('step-complete');
                circle.textContent = '‚úì';
            } else if (i === step) {
                circle.classList.add('step-active');
                circle.textContent = i;
            } else {
                circle.classList.add('step-pending');
                circle.textContent = i;
            }
        }
    }
    
    // Update progress bars
    document.getElementById('progress1').style.width = step > 1 ? '100%' : '0%';
    document.getElementById('progress2').style.width = step > 2 ? '100%' : '0%';
    
    // Generate prompt when entering step 2
    if (step === 2 && state.currentVideo) {
        generatePrompt();
    }
    
    updateAppStateDebug();
}

function resetProcess() {
    debugLog('Resetting process', 'info');
    
    state.currentStep = 1;
    state.currentVideo = null;
    
    // Reset UI
    document.getElementById('youtubeUrl').value = '';
    document.getElementById('videoPreview').classList.add('hidden');
    document.getElementById('resetBtn').classList.add('hidden');
    document.getElementById('perplexityResult').value = '';
    document.getElementById('charCount').textContent = '0';
    document.getElementById('processingStatus').classList.add('hidden');
    document.getElementById('successMessage').classList.add('hidden');
    
    // Reset progress
    document.getElementById('progress1').style.width = '0%';
    document.getElementById('progress2').style.width = '0%';
    
    // Reset step circles
    for (let i = 1; i <= 3; i++) {
        const circle = document.getElementById(`step${i}-circle`);
        circle.classList.remove('step-complete', 'step-pending');
        circle.classList.add(i === 1 ? 'step-active' : 'step-pending');
        circle.textContent = i;
    }
    
    // Show step 1
    document.querySelectorAll('[id^="step"][id$="-content"]').forEach(el => el.classList.add('hidden'));
    document.getElementById('step1-content').classList.remove('hidden');
    
    hideValidationError();
    showToast('Proceso reiniciado', 'info');
    updateAppStateDebug();
}

// ========================================
// PROMPT & PARSING
// ========================================
function generatePrompt() {
    if (!state.currentVideo) return;
    
    const prompt = `Analiza el siguiente video de d√©cima cubana y extrae todas las d√©cimas que aparecen.

VIDEO: "${state.currentVideo.title}"
CANAL: ${state.currentVideo.author}
URL: https://www.youtube.com/watch?v=${state.currentVideo.id}

INSTRUCCIONES IMPORTANTES:
1. Transcribe TODAS las d√©cimas espinelas (estrofas de 10 versos octos√≠labos, rima ABBAACCDDC).
2. Identifica el poeta/repentista que canta cada d√©cima.
3. Usa el formato EXACTO que se indica abajo.

FORMATO OBLIGATORIO PARA CADA D√âCIMA:

### D√âCIMA 1
**Poeta:** [Nombre del poeta o "Desconocido"]
**Versos:**
1. [Primer verso]
2. [Segundo verso]
3. [Tercer verso]
4. [Cuarto verso]
5. [Quinto verso]
6. [Sexto verso]
7. [S√©ptimo verso]
8. [Octavo verso]
9. [Noveno verso]
10. [D√©cimo verso]
**An√°lisis:**
- Dominio t√©cnico: [Evaluaci√≥n del octos√≠labo y la rima]
- Recursos po√©ticos: [Met√°foras, s√≠miles, etc.]
- Elementos culturales: [Referencias a Cuba, guajiro, etc.]

[Repite para cada d√©cima encontrada]

### AN√ÅLISIS GENERAL
- Temas recurrentes: [Principales temas tratados]
- Regionalismos: [Palabras o expresiones cubanas]
- Sofisticaci√≥n ling√º√≠stica: [Nivel del lenguaje]
- T√©cnicas de improvisaci√≥n: [Si aplica]
- Significado cultural: [Importancia de las d√©cimas]`;

    document.getElementById('promptText').textContent = prompt;
    debugLog('Prompt generated', 'success');
}

function copyPrompt() {
    const promptText = document.getElementById('promptText').textContent;
    navigator.clipboard.writeText(promptText)
        .then(() => {
            showToast('¬°Prompt copiado al portapapeles!', 'success');
            debugLog('Prompt copied to clipboard', 'success');
            
            // Visual feedback
            const btn = document.getElementById('copyPromptBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span>¬°Copiado!</span>';
            setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
        })
        .catch(() => showToast('Error al copiar', 'error'));
}

async function processResult() {
    const resultText = document.getElementById('perplexityResult').value.trim();
    
    if (!resultText) {
        showToast('Por favor, pega el resultado de Perplexity primero', 'error');
        return;
    }
    
    if (resultText.length < 100) {
        showToast('El texto parece muy corto. Aseg√∫rate de copiar toda la respuesta.', 'warning');
        return;
    }

    const btn = document.getElementById('processBtn');
    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner loading-spinner-sm"></div><span class="ml-2">Procesando...</span>';
    
    const processingStatus = document.getElementById('processingStatus');
    const successMessage = document.getElementById('successMessage');
    
    processingStatus.classList.remove('hidden');
    successMessage.classList.add('hidden');
    
    const startTime = performance.now();
    debugLog(`Processing ${resultText.length} characters...`, 'info');

    try {
        // Animate progress
        const progressBar = document.getElementById('processingProgress');
        const processingText = document.getElementById('processingText');
        const processingSubtext = document.getElementById('processingSubtext');
        
        progressBar.style.width = '20%';
        processingText.textContent = 'Analizando estructura...';
        await sleep(300);
        
        progressBar.style.width = '50%';
        processingText.textContent = 'Extrayendo d√©cimas...';
        await sleep(300);
        
        // Parse the result
        const parsed = parsePerplexityResult(resultText);
        
        progressBar.style.width = '80%';
        processingText.textContent = 'Procesando an√°lisis...';
        await sleep(300);
        
        if (parsed.decimas.length === 0) {
            throw new Error('No se encontraron d√©cimas v√°lidas en el texto proporcionado.');
        }

        state.decimas = parsed.decimas;
        state.analysis = parsed.analysis;

        progressBar.style.width = '100%';
        processingText.textContent = '¬°Completado!';
        await sleep(300);
        
        state.metrics.processingTime = Math.round(performance.now() - startTime);
        document.getElementById('metricProcessing').textContent = `${state.metrics.processingTime}ms`;
        
        debugLog(`Successfully parsed ${state.decimas.length} d√©cimas in ${state.metrics.processingTime}ms`, 'success');

        processingStatus.classList.add('hidden');
        successMessage.classList.remove('hidden');
        document.getElementById('successDetails').textContent = `Se extrajeron ${state.decimas.length} d√©cima${state.decimas.length !== 1 ? 's' : ''} correctamente.`;

        // Update all views
        renderDecimas();
        renderAnalysis();
        updateExportSection();
        updateDecimasCountBadge();
        saveToLocalStorage();

    } catch (error) {
        debugLog(`Processing failed: ${error.message}`, 'error');
        state.metrics.errorCount++;
        updateAppStateDebug();
        
        processingStatus.classList.add('hidden');
        showToast(error.message || 'Error al procesar. Intenta cargar la Demo para probar.', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>üöÄ</span><span>Procesar D√©cimas</span>';
    }
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ROBUST PARSING with multiple regex patterns
function parsePerplexityResult(text) {
    debugLog('Starting text parsing...', 'info');
    const decimas = [];
    const analysis = {};

    // Normalize text - handle different markdown styles
    const normalizedText = text
        .replace(/\r\n/g, '\n')
        .replace(/\*\*\*/g, '')
        .replace(/__/g, '');

    // Flexible regex for finding d√©cimas - handles ### or ** or # headers
    const decimaBlockRegex = /(?:^|\n)(?:#{1,3}\s*|\*{1,2}\s*)?D[√âE]CIMA\s*(\d+)\s*\*{0,2}([\s\S]*?)(?=(?:\n(?:#{1,3}|\*{1,2})\s*D[√âE]CIMA|\n(?:#{1,3}|\*{1,2})\s*AN[√ÅA]LISIS|$))/gi;
    
    let match;
    while ((match = decimaBlockRegex.exec(normalizedText)) !== null) {
        const number = parseInt(match[1]);
        const content = match[2];
        
        debugLog(`Found d√©cima block #${number}`, 'info');
        
        // Extract poet name - flexible pattern
        const poetPatterns = [
            /\*{0,2}Poeta:\*{0,2}\s*(.+?)(?:\n|$)/i,
            /Poeta\s*[:\-]\s*(.+?)(?:\n|$)/i,
            /Por:\s*(.+?)(?:\n|$)/i
        ];
        
        let poet = 'Desconocido';
        for (const pattern of poetPatterns) {
            const poetMatch = content.match(pattern);
            if (poetMatch) {
                poet = poetMatch[1].trim().replace(/\*+/g, '').trim();
                break;
            }
        }

        // Extract verses - multiple patterns
        const verses = [];
        
        // Pattern 1: Numbered verses (1. verse, 1) verse, 1- verse)
        const numberedVerseRegex = /^\s*(\d{1,2})\s*[.\-)\]]\s*(.+)$/gm;
        let verseMatch;
        const tempVerses = [];
        
        while ((verseMatch = numberedVerseRegex.exec(content)) !== null) {
            const verseNum = parseInt(verseMatch[1]);
            const verseText = verseMatch[2].trim()
                .replace(/\*+/g, '')
                .replace(/^["¬´]|["¬ª]$/g, '')
                .trim();
            
            if (verseText.length > 2 && verseNum <= 10) {
                tempVerses.push({ num: verseNum, text: verseText });
            }
        }
        
        // Sort by verse number and extract text
        tempVerses.sort((a, b) => a.num - b.num);
        tempVerses.forEach(v => verses.push(v.text));
        
        // If we got at least 8 verses, consider it valid
        if (verses.length >= 8) {
            // Extract analysis fields
            const decimaAnalysis = {
                technicalMastery: extractAnalysisField(content, ['Dominio t√©cnico', 'T√©cnica', 'Maestr√≠a']),
                poeticDevices: extractAnalysisField(content, ['Recursos po√©ticos', 'Figuras', 'Recursos']),
                culturalElements: extractAnalysisField(content, ['Elementos culturales', 'Cultural', 'Contexto'])
            };
            
            decimas.push({
                poet,
                number: decimas.length + 1, // Renumber sequentially
                verses: verses.slice(0, 10),
                rhymeScheme: 'ABBAACCDDC',
                analysis: decimaAnalysis
            });
            
            debugLog(`D√©cima #${number} parsed: ${verses.length} verses by ${poet}`, 'success');
        } else {
            debugLog(`D√©cima #${number} skipped: only ${verses.length} verses found`, 'warning');
        }
    }

    // Parse general analysis section
    const analysisPatterns = [
        /(?:#{1,3}|\*{1,2})\s*AN[√ÅA]LISIS\s*GENERAL\s*\*{0,2}([\s\S]*?)$/i,
        /AN[√ÅA]LISIS\s*GENERAL[:\s]*([\s\S]*?)$/i
    ];
    
    for (const pattern of analysisPatterns) {
        const analysisSection = normalizedText.match(pattern);
        if (analysisSection) {
            const c = analysisSection[1];
            analysis.themes = extractAnalysisField(c, ['Temas recurrentes', 'Temas', 'Tem√°tica']);
            analysis.regionalisms = extractAnalysisField(c, ['Regionalismos', 'Regional', 'Cubanismos']);
            analysis.linguistic = extractAnalysisField(c, ['Sofisticaci√≥n ling√º√≠stica', 'Sofisticaci√≥n', 'Lenguaje']);
            analysis.techniques = extractAnalysisField(c, ['T√©cnicas de improvisaci√≥n', 'T√©cnicas', 'Improvisaci√≥n']);
            analysis.cultural = extractAnalysisField(c, ['Significado cultural', 'Significado', 'Importancia']);
            break;
        }
    }

    debugLog(`Parsing complete: ${decimas.length} d√©cimas, analysis: ${Object.keys(analysis).length} fields`, 'success');
    return { decimas, analysis };
}

function extractAnalysisField(text, fieldNames) {
    for (const field of fieldNames) {
        // Try multiple patterns for each field name
        const patterns = [
            new RegExp(`[-*‚Ä¢]?\\s*${field}[:\\s]+(.+?)(?=[-*‚Ä¢]\\s*[A-Z]|\\n\\n|$)`, 'is'),
            new RegExp(`${field}[:\\s]+(.+?)(?=\\n|$)`, 'i')
        ];
        
        for (const regex of patterns) {
            const match = text.match(regex);
            if (match) {
                return match[1].trim()
                    .replace(/^\*+|\*+$/g, '')
                    .replace(/^[-‚Ä¢]\s*/, '')
                    .trim() || 'No disponible';
            }
        }
    }
    return 'No disponible';
}

function loadSampleData() {
    debugLog('Loading sample demo data', 'info');
    
    state.decimas = sampleDecimas;
    state.analysis = { 
        themes: "Amor a la tierra cubana, tradici√≥n campesina, orgullo cultural",
        regionalisms: "Guajiro, boh√≠o, punto, montuno, jiribilla",
        linguistic: "Uso elevado del octos√≠labo con vocabulario campesino tradicional",
        techniques: "Repentismo cl√°sico con pausas dram√°ticas y variaci√≥n tonal",
        cultural: "Las d√©cimas representan la resistencia cultural y la identidad cubana a trav√©s de generaciones"
    };
    
    if (!state.currentVideo) {
        state.currentVideo = { 
            id: 'demo', 
            title: 'Demo - D√©cimas Cubanas', 
            author: 'Viajera Digital', 
            thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/hqdefault.jpg' 
        };
    }
    
    renderDecimas();
    renderAnalysis();
    updateExportSection();
    updateDecimasCountBadge();
    saveToLocalStorage();
    
    showToast(`Datos demo cargados: ${sampleDecimas.length} d√©cimas`, 'success');
}

// ========================================
// RENDERING
// ========================================
function renderDecimas() {
    const container = document.getElementById('decimasList');
    const noMessage = document.getElementById('noDecimasMessage');
    const countDisplay = document.getElementById('decimasCount');
    
    if (state.decimas.length === 0) {
        container.classList.add('hidden');
        noMessage.classList.remove('hidden');
        countDisplay.textContent = '0 d√©cimas';
        return;
    }
    
    noMessage.classList.add('hidden');
    container.classList.remove('hidden');
    countDisplay.textContent = `${state.decimas.length} d√©cima${state.decimas.length !== 1 ? 's' : ''}`;
    
    // Rhyme scheme colors: ABBAACCDDC
    const rhymeColors = ['rhyme-a', 'rhyme-b', 'rhyme-b', 'rhyme-a', 'rhyme-a', 'rhyme-c', 'rhyme-c', 'rhyme-d', 'rhyme-d', 'rhyme-c'];
    const rhymeLetters = ['A', 'B', 'B', 'A', 'A', 'C', 'C', 'D', 'D', 'C'];
    
    container.innerHTML = state.decimas.map((d, idx) => {
        const versesHTML = d.verses.map((v, i) => {
            const safeVerse = escapeHtml(v);
            return `<div class="decima-verse pl-4 py-1.5 flex gap-3 text-amber-100/90 italic text-[15px]">
                <span class="text-xs font-mono opacity-60 w-5 text-center ${rhymeColors[i] || ''}" title="Rima ${rhymeLetters[i] || ''}">${i + 1}</span>
                <span>${safeVerse}</span>
            </div>`;
        }).join('');
        
        return `
        <article class="bg-gradient-to-r from-amber-900/25 to-amber-800/15 rounded-xl p-6 border border-amber-900/40 fade-in" style="animation-delay: ${idx * 50}ms">
            <div class="flex justify-between items-start mb-4 flex-wrap gap-2">
                <span class="px-3 py-1 bg-amber-500/20 text-amber-400 text-sm font-bold rounded-lg">#${d.number}</span>
                <span class="text-amber-200/80 font-medium">${escapeHtml(d.poet)}</span>
            </div>
            <div class="space-y-1 mb-5" role="list" aria-label="Versos de la d√©cima">
                ${versesHTML}
            </div>
            <div class="flex items-center gap-2 text-xs text-amber-200/50 mb-3">
                <span>Esquema de rima:</span>
                <span class="font-mono tracking-wider">${d.rhymeScheme}</span>
            </div>
            <details class="group">
                <summary class="text-sm text-amber-400 hover:text-amber-300 cursor-pointer py-2 flex items-center gap-2">
                    <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    Ver an√°lisis detallado
                </summary>
                <div class="mt-3 p-4 bg-amber-900/20 rounded-lg text-sm text-amber-200/70 space-y-2">
                    <p><strong class="text-amber-300">Dominio t√©cnico:</strong> ${escapeHtml(d.analysis.technicalMastery)}</p>
                    <p><strong class="text-amber-300">Recursos po√©ticos:</strong> ${escapeHtml(d.analysis.poeticDevices)}</p>
                    <p><strong class="text-amber-300">Elementos culturales:</strong> ${escapeHtml(d.analysis.culturalElements)}</p>
                </div>
            </details>
        </article>`;
    }).join('');
}

function renderAnalysis() {
    const noMessage = document.getElementById('noAnalysisMessage');
    const content = document.getElementById('analysisContent');
    
    if (!state.analysis || Object.keys(state.analysis).length === 0) {
        noMessage.classList.remove('hidden');
        content.classList.add('hidden');
        return;
    }
    
    noMessage.classList.add('hidden');
    content.classList.remove('hidden');

    // Update video info if available
    if (state.currentVideo) {
        const thumb = document.getElementById('analysisVideoThumb');
        if (state.currentVideo.thumbnail) {
            thumb.src = state.currentVideo.thumbnail;
            thumb.classList.remove('hidden');
        }
        document.getElementById('analysisVideoTitle').textContent = state.currentVideo.title || 'Video';
        document.getElementById('analysisVideoMeta').textContent = `Por: ${state.currentVideo.author || 'Desconocido'}`;
    }

    // Update analysis fields using textContent for security
    const fieldMappings = {
        'analysisThemes': 'themes',
        'analysisRegionalisms': 'regionalisms',
        'analysisLinguistic': 'linguistic',
        'analysisTechniques': 'techniques',
        'analysisCultural': 'cultural'
    };
    
    for (const [elementId, stateKey] of Object.entries(fieldMappings)) {
        const el = document.getElementById(elementId);
        if (el) {
            el.textContent = state.analysis[stateKey] || 'No disponible';
        }
    }

    // Render Top 3 D√©cimas
    const topThreeContainer = document.getElementById('topThreeDecimas');
    const topDecimas = state.decimas.slice(0, 3);
    
    if (topDecimas.length > 0) {
        const medals = ['ü•á', 'ü•à', 'ü•â'];
        const medalClasses = ['medal-gold', 'medal-silver', 'medal-bronze'];
        
        topThreeContainer.innerHTML = topDecimas.map((d, i) => `
            <div class="flex gap-4 bg-amber-900/30 rounded-xl p-4 border border-amber-500/20">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 ${medalClasses[i]}">${medals[i]}</div>
                <div class="min-w-0 flex-1">
                    <p class="font-semibold text-amber-100">${escapeHtml(d.poet)}</p>
                    <p class="text-sm text-amber-200/60 italic truncate">"${escapeHtml(d.verses[0])}..."</p>
                </div>
            </div>
        `).join('');
    } else {
        topThreeContainer.innerHTML = '<p class="text-amber-200/50 text-sm">No hay d√©cimas para mostrar</p>';
    }
}

function renderPoets() {
    const container = document.getElementById('poetsGrid');
    
    container.innerHTML = poets.map((p, i) => `
        <article class="poet-card rounded-xl p-5 fade-in" style="animation-delay: ${i * 50}ms">
            <div class="flex gap-3 mb-3">
                <div class="w-12 h-12 rounded-full bg-amber-800/50 flex items-center justify-center text-xl flex-shrink-0" aria-hidden="true">${p.image}</div>
                <div class="min-w-0">
                    <h3 class="font-semibold text-amber-100 text-sm truncate">${escapeHtml(p.name)}</h3>
                    <p class="text-xs text-amber-200/50">${p.years}</p>
                </div>
            </div>
            <p class="text-xs text-amber-200/70 mb-3 line-clamp-2">${escapeHtml(p.bio)}</p>
            <span class="inline-block text-xs bg-amber-900/40 text-amber-400 px-2 py-1 rounded">${p.specialty}</span>
        </article>
    `).join('');
}

function updateExportSection() {
    const noMessage = document.getElementById('noExportMessage');
    const options = document.getElementById('exportOptions');
    
    if (state.decimas.length > 0) {
        noMessage.classList.add('hidden');
        options.classList.remove('hidden');
    } else {
        noMessage.classList.remove('hidden');
        options.classList.add('hidden');
    }
}

function updateDecimasCountBadge() {
    const badge = document.getElementById('decimasCountBadge');
    if (state.decimas.length > 0) {
        badge.textContent = state.decimas.length;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// ========================================
// STORAGE
// ========================================
function saveToLocalStorage() {
    try {
        const dataToSave = {
            currentVideo: state.currentVideo,
            decimas: state.decimas,
            analysis: state.analysis,
            savedAt: new Date().toISOString()
        };
        localStorage.setItem('viajera-state-v3', JSON.stringify(dataToSave));
        debugLog('State saved to localStorage', 'success');
    } catch (error) {
        debugLog(`Failed to save to localStorage: ${error.message}`, 'error');
    }
}

function loadFromLocalStorage() {
    try {
        const saved = localStorage.getItem('viajera-state-v3');
        if (saved) {
            const data = JSON.parse(saved);
            if (data.decimas?.length > 0) {
                state.currentVideo = data.currentVideo;
                state.decimas = data.decimas;
                state.analysis = data.analysis;
                
                renderDecimas();
                renderAnalysis();
                updateExportSection();
                updateDecimasCountBadge();
                
                debugLog(`Loaded ${data.decimas.length} d√©cimas from localStorage (saved: ${data.savedAt})`, 'success');
            }
        }
    } catch (error) {
        debugLog(`Failed to load from localStorage: ${error.message}`, 'error');
    }
}

function clearAllData() {
    if (!confirm('¬øEst√°s seguro de que quieres borrar todos los datos? Esta acci√≥n no se puede deshacer.')) {
        return;
    }
    
    state.decimas = [];
    state.analysis = null;
    state.currentVideo = null;
    
    localStorage.removeItem('viajera-state-v3');
    
    renderDecimas();
    renderAnalysis();
    updateExportSection();
    updateDecimasCountBadge();
    
    debugLog('All data cleared', 'warning');
    showToast('Todos los datos han sido borrados', 'success');
}

// ========================================
// EXPORTING
// ========================================
function exportAsPDF() {
    debugLog('Exporting as PDF...', 'info');
    
    const title = state.currentVideo?.title || 'D√©cimas Cubanas';
    const author = state.currentVideo?.author || 'Desconocido';
    
    const content = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${escapeHtml(title)}</title>
    <style>
        body { font-family: Georgia, serif; padding: 40px; color: #333; max-width: 800px; margin: 0 auto; }
        h1 { color: #8B4513; border-bottom: 2px solid #D4A855; padding-bottom: 10px; }
        h2 { color: #8B4513; margin-top: 30px; }
        .decima { margin: 30px 0; page-break-inside: avoid; }
        .poet { font-weight: bold; color: #8B4513; margin-bottom: 10px; }
        .verse { margin: 4px 0; padding-left: 20px; }
        .verse-num { color: #888; font-size: 12px; display: inline-block; width: 20px; }
        .meta { color: #666; font-size: 14px; margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px; }
        @media print { body { padding: 20px; } }
    </style>
</head>
<body>
    <h1>${escapeHtml(title)}</h1>
    <p><strong>Canal:</strong> ${escapeHtml(author)}</p>
    <p><strong>Exportado:</strong> ${new Date().toLocaleDateString('es-ES', { dateStyle: 'full' })}</p>
    
    ${state.decimas.map(d => `
        <div class="decima">
            <h2>D√©cima ${d.number}</h2>
            <p class="poet">${escapeHtml(d.poet)}</p>
            ${d.verses.map((v, i) => `<div class="verse"><span class="verse-num">${i + 1}.</span> ${escapeHtml(v)}</div>`).join('')}
        </div>
    `).join('')}
    
    <div class="meta">
        <p>Generado por Viajera Digital v3.3</p>
    </div>
</body>
</html>`;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
    
    showToast('Documento preparado para impresi√≥n', 'success');
}

function exportAsText() {
    debugLog('Exporting as TXT...', 'info');
    
    const title = state.currentVideo?.title || 'D√©cimas Cubanas';
    const author = state.currentVideo?.author || 'Desconocido';
    
    let content = `D√âCIMAS CUBANAS\n`;
    content += `${'='.repeat(50)}\n\n`;
    content += `Video: ${title}\n`;
    content += `Canal: ${author}\n`;
    content += `Exportado: ${new Date().toLocaleString('es-ES')}\n\n`;
    content += `${'='.repeat(50)}\n\n`;
    
    state.decimas.forEach(d => {
        content += `D√âCIMA ${d.number}\n`;
        content += `Poeta: ${d.poet}\n`;
        content += `${'-'.repeat(30)}\n`;
        d.verses.forEach((v, i) => {
            content += `${(i + 1).toString().padStart(2, ' ')}. ${v}\n`;
        });
        content += `\n`;
    });
    
    content += `\n${'='.repeat(50)}\n`;
    content += `Generado por Viajera Digital v3.3\n`;
    
    downloadFile('decimas-cubanas.txt', content, 'text/plain');
    showToast('Archivo TXT descargado', 'success');
}

function exportAsJSON() {
    debugLog('Exporting as JSON...', 'info');
    
    const exportData = {
        metadata: {
            exportedAt: new Date().toISOString(),
            version: '3.3.0',
            source: 'Viajera Digital'
        },
        video: state.currentVideo,
        decimas: state.decimas,
        analysis: state.analysis
    };
    
    downloadFile('decimas-cubanas.json', JSON.stringify(exportData, null, 2), 'application/json');
    showToast('Archivo JSON descargado', 'success');
}

function exportAsMarkdown() {
    debugLog('Exporting as Markdown...', 'info');
    
    const title = state.currentVideo?.title || 'D√©cimas Cubanas';
    const author = state.currentVideo?.author || 'Desconocido';
    
    let content = `# ${title}\n\n`;
    content += `**Canal:** ${author}  \n`;
    content += `**Exportado:** ${new Date().toLocaleDateString('es-ES')}  \n\n`;
    content += `---\n\n`;
    
    state.decimas.forEach(d => {
        content += `## D√©cima ${d.number}\n\n`;
        content += `**Poeta:** ${d.poet}\n\n`;
        content += `> `;
        content += d.verses.join('  \n> ');
        content += `\n\n`;
        
        content += `**An√°lisis:**\n`;
        content += `- *Dominio t√©cnico:* ${d.analysis.technicalMastery}\n`;
        content += `- *Recursos po√©ticos:* ${d.analysis.poeticDevices}\n`;
        content += `- *Elementos culturales:* ${d.analysis.culturalElements}\n\n`;
    });
    
    if (state.analysis) {
        content += `---\n\n`;
        content += `## An√°lisis General\n\n`;
        content += `- **Temas recurrentes:** ${state.analysis.themes || 'N/A'}\n`;
        content += `- **Regionalismos:** ${state.analysis.regionalisms || 'N/A'}\n`;
        content += `- **Sofisticaci√≥n ling√º√≠stica:** ${state.analysis.linguistic || 'N/A'}\n`;
        content += `- **T√©cnicas de improvisaci√≥n:** ${state.analysis.techniques || 'N/A'}\n`;
        content += `- **Significado cultural:** ${state.analysis.cultural || 'N/A'}\n\n`;
    }
    
    content += `---\n\n`;
    content += `*Generado por [Viajera Digital](https://github.com) v3.3*\n`;
    
    downloadFile('decimas-cubanas.md', content, 'text/markdown');
    showToast('Archivo Markdown descargado', 'success');
}

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    debugLog(`Downloaded: ${filename}`, 'success');
}

// ========================================
// UI HELPERS
// ========================================
function openAboutModal() { 
    const modal = document.getElementById('aboutModal');
    modal.classList.remove('hidden'); 
    modal.classList.add('flex');
    modal.querySelector('button').focus();
    document.body.style.overflow = 'hidden';
}

function closeAboutModal() { 
    const modal = document.getElementById('aboutModal');
    modal.classList.add('hidden'); 
    modal.classList.remove('flex');
    document.body.style.overflow = '';
}

function showToast(msg, type = 'info') {
    const toast = document.getElementById('toast');
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    const colors = { 
        success: 'bg-green-600', 
        error: 'bg-red-600', 
        warning: 'bg-yellow-600', 
        info: 'bg-blue-600' 
    };
    
    toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 transition-opacity duration-300 ${colors[type] || colors.info} text-white flex items-center gap-3`;
    document.getElementById('toastIcon').textContent = icons[type] || icons.info;
    document.getElementById('toastMessage').textContent = msg;
    
    toast.classList.remove('opacity-0', 'pointer-events-none');
    
    setTimeout(() => {
        toast.classList.add('opacity-0', 'pointer-events-none');
    }, 3500);
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ========================================
// KEYBOARD SHORTCUTS
// ========================================
document.addEventListener('keydown', e => {
    // Escape to close modal
    if (e.key === 'Escape') {
        closeAboutModal();
    }
    
    // Ctrl/Cmd + D to toggle debug panel
    if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
        e.preventDefault();
        toggleDebugPanel();
    }
    
    // Ctrl/Cmd + S to save (prevent default, show toast)
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (state.decimas.length > 0) {
            saveToLocalStorage();
            showToast('Progreso guardado', 'success');
        }
    }
});
</script>
</body>
</html>
